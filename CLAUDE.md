# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Veda (DeskBubby) is a full-stack Dart application using **Serverpod 3.2.3** as the backend framework and **Flutter** for the frontend. It targets iOS, Android, macOS, Windows, Linux, and Web.

## Repository Structure

Three-package monorepo:

- **veda_server/** — Serverpod backend (PostgreSQL + Redis, RPC endpoints, auth, migrations)
- **veda_flutter/** — Flutter frontend (multi-platform UI)
- **veda_client/** — Auto-generated client library (protocol types, client SDK). Generated by `serverpod generate` from server definitions.

Dependency chain: `veda_flutter` → `veda_client` ← generated from `veda_server`

## Common Commands

### Server setup (requires Docker for PostgreSQL & Redis)
```bash
cd veda_server
docker compose up --build --detach   # start Postgres & Redis
dart pub get                          # install dependencies
serverpod generate                    # generate protocol/client code
dart bin/main.dart                    # run the server (ports 8080-8082)
docker compose stop                   # stop services when done
```

### Flutter app
```bash
cd veda_flutter
flutter pub get
flutter run
```

### Build Flutter web (outputs to veda_server/web/app/)
```bash
cd veda_flutter
flutter build web --base-href /app/ --wasm
```

### Run tests
```bash
cd veda_server
dart test                             # all tests (requires Docker services running)
dart test test/integration/greeting_endpoint_test.dart  # single test file
```

Tests are tagged — `dart_test.yaml` defines an `integration` tag.

### Lint and format
```bash
dart analyze --fatal-infos            # static analysis (used in CI)
dart format .                         # format code
dart format --set-exit-if-changed .   # check formatting (used in CI)
```

## Architecture

### Code Generation Workflow
1. Define endpoints and models in `veda_server/lib/src/`
2. Run `serverpod generate` in `veda_server/` — this generates:
   - `veda_server/lib/src/generated/` (server-side protocol)
   - `veda_client/lib/src/protocol/` (client-side protocol)
3. Flutter app uses generated types via `veda_client` (path dependency at `../veda_client`)

Never manually edit files in `generated/` directories.

### Endpoint Pattern
Endpoints extend `Endpoint` and receive a `Session` parameter for database/auth access:
```dart
class GreetingEndpoint extends Endpoint {
  Future<Greeting> hello(Session session, String name) async { ... }
}
```
Client calls: `client.greeting.hello(name)`

### Authentication
- JWT token manager with email/password identity provider (`serverpod_auth_idp`)
- Endpoints: `EmailIdpEndpoint`, `JwtRefreshEndpoint`
- Flutter uses `ServerpodAuthIdp` widget for sign-in flow

### Database
- PostgreSQL with pgvector extension
- Migrations in `veda_server/migrations/` (SQL-based, managed by Serverpod)
- Apply migrations on server start: `dart bin/main.dart --apply-migrations`

### Configuration
Server configs in `veda_server/config/`: `development.yaml`, `staging.yaml`, `production.yaml`, `test.yaml`, `passwords.yaml`

## Design System

The app follows a **Neo-Minimalist Line Art** aesthetic (see `desgin guidlines.md`):

- **Dark mode**: Pure black (#000000) background, white text, grey scale accents
- **Single accent color**: Blue (#4A90E2), used sparingly (<5% of screen)
- **Typography**: Ultra-light weights (w300) for headings, never bold
- **Grid**: 4-column Swiss grid, 48px baseline, all spacing in multiples of 12px
- **Strokes**: 0.5pt–1pt only, no solid fills, no shadows, no gradients
- **Touch targets**: 56px minimum height
- **Content width**: Max 440px centered
- **Contrast**: WCAG AAA (7:1+ ratio)
- **Animations**: 150–300ms with easeOut curves, no bounces or elastic effects

## CI

GitHub Actions workflows (`.github/workflows/`):
- **analyze.yml**: `dart analyze --fatal-infos` on veda_server
- **format.yml**: `dart format --set-exit-if-changed` check
- **tests.yml**: Full test suite with Docker services (Flutter 3.32.8, Serverpod 3.2.3)

## Key Versions

- Dart SDK: `^3.8.0`
- Flutter SDK: `^3.32.0`
- Serverpod: `3.2.3` (locked across all packages)
